---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: mopidy
  namespace: radio
spec:
  dependsOn:
  - name: authelia
    namespace: auth
  - name: longhorn
    namespace: storage
  - name: snapserver
    namespace: radio
  interval: 5m
  install:
    timeout: 15m
    remediation:
      retries: 5
  upgrade:
    timeout: 15m
    remediation:
      retries: 5
      remediateLastFailure: true
    cleanupOnFail: true
  chart:
    spec:
      # renovate: registryUrl=https://charts.buvis.net
      chart: mopidy
      version: 0.5.2
      sourceRef:
        kind: HelmRepository
        name: buvis
        namespace: flux-system
      interval: 5m
  values:
    image:
      repository: ghcr.io/buvis/mopidy
      tag: v3.66.1@sha256:3fc2a05f8e33f4033b309eda56dfae3c4d8e72ce46903b13c18f79ecf6eea970
    service:
      main:
        enabled: true
        type: loadBalancer
        loadBalancerIP: ${SVC_MOPIDY_ADDR}
        externalTrafficPolicy: Local
        ports:
          http:
            port: 6680
      zeroconf:
        enabled: true
        type: loadBalancer
        loadBalancerIP: ${SVC_MOPIDY_ADDR}
        externalTrafficPolicy: Local
        ports:
          http:
            port: 6600
    ingress:
      main:
        enabled: true
        ingressClassName: nginx
        annotations:
          hajimari.io/enable: "true"
          hajimari.io/appName: "Home Radio"
          hajimari.io/icon: "radio"
          hajimari.io/group: "radio"
        hosts:
        - host: &host "radio.${SECRET_DOMAIN}"
          paths:
          - path: /
            pathType: Prefix
        tls:
        - hosts:
            - *host

    persistence:
      media:
        enabled: true
        existingClaim: mopidy-music-pvc
      data:
        enabled: true
        existingClaim: mopidy-data-pvc
    config:
      customConfig: |
        [core]
        cache_dir = /app/cache
        config_dir = /config
        data_dir = /app

        [logging]
        verbosity = 4
        format = %(levelname)-8s %(asctime)s [%(process)d:%(threadName)s] %(name)s\n  %(message)s
        color = true
        config_file =

        [audio]
        mixer = software
        output = audioresample ! audioconvert ! audio/x-raw,rate=48000,channels=2,format=S16LE ! wavenc ! tcpclientsink host=${SVC_SNAPSERVER_ADDR} port=4955
        mixer_volume = 45

        [file]
        enabled = true
        media_dirs = /media
        show_dotfiles = false
        excluded_file_extensions =
        .cda
        .directory
        .html
        .jpeg
        .jpg
        .lnk
        .log
        .m3u8
        .nfo
        .nmx
        .pdf
        .png
        .txt
        .url
        .zip
        follow_symlinks = true
        metadata_timeout = 1000

        [local]
        library = sqlite
        scan_flush_threshold = 100
        media_dir = /media
        scan_timeout = 4000
        excluded_file_extensions =
        .bmp
        .cue
        .png
        .jpg
        .jpeg
        .doc
        .docx
        .nfo
        .txt
        .m3u
        .sfv
        .zip

        [mpd]
        hostname = 0.0.0.0
        zeroconf = $hostname

        [http]
        enabled = true
        hostname = 0.0.0.0
        port = 6680
        default_app = iris
        zeroconf = $hostname
        csrf_protection = false

        [tidal]
        enabled = false
