---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app mopidy
  namespace: radio
spec:
  dependsOn:
  - name: longhorn
    namespace: storage
  - name: snapserver
    namespace: radio
  - name: jellyfin
    namespace: media
  interval: 5m
  install:
    timeout: 15m
    remediation:
      retries: 5
  upgrade:
    timeout: 15m
    remediation:
      retries: 5
      remediateLastFailure: true
    cleanupOnFail: true
  chart:
    spec:
      # renovate: registryUrl=https://charts.buvis.net
      chart: mopidy
      version: 0.5.2
      sourceRef:
        kind: HelmRepository
        name: buvis
        namespace: flux-system
      interval: 5m
  values:
    controller:
      type: statefulset

    image:
      repository: brain:5000/mopidy
      tag: latest
      pullPolicy: Always
    service:
      main:
        annotations:
          metallb.universe.tf/allow-shared-ip: "key-to-share-${SVC_MOPIDY_ADDR}"
        enabled: true
        type: LoadBalancer
        loadBalancerIP: ${SVC_MOPIDY_ADDR}
        externalTrafficPolicy: Local
        ports:
          http:
            port: 6680
      zeroconf:
        annotations:
          metallb.universe.tf/allow-shared-ip: "key-to-share-${SVC_MOPIDY_ADDR}"
        enabled: true
        type: LoadBalancer
        loadBalancerIP: ${SVC_MOPIDY_ADDR}
        externalTrafficPolicy: Local
        ports:
          http:
            port: 6600
    ingress:
      main:
        enabled: true
        ingressClassName: nginx
        annotations:
          hajimari.io/enable: "true"
          hajimari.io/appName: "Home Radio"
          hajimari.io/icon: "radio"
          hajimari.io/group: "radio"
        hosts:
        - host: &host "radio.${SECRET_DOMAIN}"
          paths:
          - path: /
            pathType: Prefix
        tls:
        - hosts:
            - *host

    persistence:
      data:
        enabled: true
        existingClaim: mopidy-data-pvc

    resources:
      requests:
        cpu: 60m
        memory: 512M
      limits:
        memory: 512M

    config:
      customConfig: |
        [core]
        cache_dir = /app/cache
        config_dir = /config
        data_dir = /app

        [logging]
        verbosity = 4
        format = %(levelname)-8s %(asctime)s [%(process)d:%(threadName)s] %(name)s\n  %(message)s
        color = true
        config_file =

        [audio]
        mixer = software
        output = audioresample ! audioconvert ! audio/x-raw,rate=48000,channels=2,format=S16LE ! wavenc ! tcpclientsink host=${SVC_SNAPSERVER_ADDR} port=4955
        mixer_volume = 45

        [mpd]
        hostname = 0.0.0.0
        zeroconf = $hostname

        [http]
        enabled = true
        hostname = 0.0.0.0
        port = 6680
        default_app = iris
        zeroconf = $hostname
        csrf_protection = false

        [tidal]
        enabled = false

        [local]
        enabled = false

        [scrobbler]
        enabled = false

        [file]
        enabled = false

        [youtube]
        enabled = false

        [tunein]
        enabled = false

        [jellyfin]
        hostname = http://jellyfin.${SECRET_DOMAIN}
        username = kodi
        password = kodi

        [spotify]
        username = ${SPOTIFY_USERNAME}
        password = ${SPOTIFY_PASSWORD}
        client_id = ${SPOTIFY_CLIENT_ID}
        client_secret = ${SPOTIFY_CLIENT_SECRET}

