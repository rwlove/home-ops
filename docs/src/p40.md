# nVIDIA Tesla P40

nVIDIA GPU ignored on Host (Dell R730xd, CentOS 9), PCI Passthrough to KVM VM, running CentOS 9 as a K8S node running nVIDIA Operator pods.

## nVIDIA Operator

### Host system ignore PCI device

1. Apend to GRUB_CMDLINE_LINUX in /etc/default/grub

`intel_iommu=on pci-stub.ids=10de:1b38`

2. grub2-mkconfig -o /boot/grub2/grub.cfg

3. reboot

### PCI Passthrough to VM

1. Add Hardware -> PCI Host Device

### Blacklist nouveau in VM

1. echo "blacklist nouveau" > /etc/modprobe.d/blacklist-nouveau.conf 

2. reboot

### Install Driver on K8S Node directly, not from Operator Helm Chart

[Guide](https://www.if-not-true-then-false.com/2021/install-nvidia-drivers-on-centos-rhel-rocky-linux/#11-check-is-your-nvidia-card-supported)

`
➜  ~ chmod +x ./NVIDIA-Linux-x86_64-550.54.15.run 
➜  ~ ./NVIDIA-Linux-x86_64-550.54.15.run
`

* enable DKMS
* install 32bit libraries (do I need this?)

`
  WARNING: Unable to determine the path to install the libglvnd EGL vendor library config files. Check that you have pkg-config and the libglvnd development libraries
           installed, or specify a path with --glvnd-egl-config-path.
`
`
➜  ~ lsmod| grep -i nvid 
nvidia_drm            131072  0
nvidia_modeset       1355776  1 nvidia_drm
nvidia              54145024  1 nvidia_modeset
video                  73728  1 nvidia_modeset
drm_kms_helper        245760  4 virtio_gpu,nvidia_drm
drm                   741376  7 drm_kms_helper,drm_shmem_helper,nvidia,virtio_gpu,nvidia_drm
`

### Install nVIDIA Container Toolkit

* `curl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \\n  sudo tee /etc/yum.repos.d/nvidia-container-toolkit.repo`
* `dnf -y install -y nvidia-container-toolkit`
* `nvidia-ctk runtime configure --runtime=crio`

`nvidia-smi` shows no devices ; need to fix this.

It seems that the operator validator container 'driver-validation' `kubectl -n kube-system logs nvidia-operator-validator-p269h -c driver-validation` is what is failing.

dmesg output on VM

`
[  +0.500311] nvidia_uvm: module uses symbols from proprietary module nvidia, inheriting taint.
[  +0.221113] nvidia-uvm: Loaded the UVM driver, major device number 234.
[  +0.115737] NVRM: GPU 0000:0a:00.0: GPU does not have the necessary power cables connected.
[  +0.000984] NVRM: GPU 0000:0a:00.0: RmInitAdapter failed! (0x24:0x1c:1556)
[  +0.000341] NVRM: GPU 0000:0a:00.0: rm_init_adapter failed, device minor number 0
[  +0.115769] NVRM: GPU 0000:0a:00.0: GPU does not have the necessary power cables connected.
[  +0.000714] NVRM: GPU 0000:0a:00.0: RmInitAdapter failed! (0x24:0x1c:1556)
[  +0.000340] NVRM: GPU 0000:0a:00.0: rm_init_adapter failed, device minor number 0
`


## Configuration with NFD / LocalAI / Ollama / etc