# nVIDIA Tesla P40

nVIDIA GPU ignored on Host (Dell R730xd, CentOS 9), PCI Passthrough to KVM VM, running CentOS 9 as a K8S node running nVIDIA Operator pods.

## nVIDIA Operator

### Host system ignore PCI device

1. Apend to GRUB_CMDLINE_LINUX in /etc/default/grub

`intel_iommu=on pci-stub.ids=10de:1b38`

2. grub2-mkconfig -o /boot/grub2/grub.cfg

3. reboot

### PCI Passthrough to VM

1. Add Hardware -> PCI Host Device

### Blacklist nouveau in VM

1. echo "blacklist nouveau" > /etc/modprobe.d/blacklist-nouveau.conf 

2. reboot

### Install Driver on K8S Node directly, not from Operator Helm Chart

[Guide](https://www.if-not-true-then-false.com/2021/install-nvidia-drivers-on-centos-rhel-rocky-linux/#11-check-is-your-nvidia-card-supported)

```
➜  ~ chmod +x ./NVIDIA-Linux-x86_64-550.54.15.run 
➜  ~ ./NVIDIA-Linux-x86_64-550.54.15.run
```

## Configure CRI-O
[Configure CRI-O](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html#configuring-cri-o)


### Install nVIDIA Device Plugin

## See Helm Chart

### stable-diffusion

## On node install TCMalloc

dnf install -y gperftools gperftools-deve

### Fan Speed

[IPMI Fan Script Discussion] (https://www.reddit.com/r/homelab/comments/1217lkl/issues_with_fan_speed_in_r720_with_nvidia_tesla/)
[Fan Control Script] (https://github.com/brezlord/iDRAC7_fan_control)

## Configuration with NFD / LocalAI / Ollama / etc
