<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js latte">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Home Operations</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="././assets/css/mdbook-admonish.css">
        <link rel="stylesheet" href="./theme/catppuccin.css">
        <link rel="stylesheet" href="./theme/catppuccin-highlight.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "macchiato" : "latte";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('latte')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Welcome</li><li class="chapter-item expanded "><a href="introduction.html">üëã Introduction</a></li><li class="chapter-item expanded "><a href="coral.html">Coral</a></li><li class="chapter-item expanded "><a href="p40.html">nVidia Tesla P40</a></li><li class="chapter-item expanded "><a href="cluster_rebuild.html">Cluster Rebuild Actions</a></li><li class="chapter-item expanded "><a href="init_teardown.html">Initialization and Teardown</a></li><li class="chapter-item expanded "><a href="immich_cnpg.html">Immich restore to new CNPG database</a></li><li class="chapter-item expanded "><a href="github_webhook.html">Github Webhook</a></li><li class="chapter-item expanded "><a href="limits.html">Resources: Limits and Requests Philosophy</a></li><li class="chapter-item expanded "><a href="debugging.html">Debugging</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="latte">Latte (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="frappe">Frapp√©</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="macchiato">Macchiato</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mocha">Mocha</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Home Operations</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rwlove/home-ops" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="introduction.html#admonition-warning"></a>
</div>
<div>
<p>These docs contain information that relates to my setup.
They may or may not work for you.</p>
</div>
</div>
<hr />
<br />
<div align="center">
<img src="https://github.com/rwlove/home-ops/blob/870b6ed06e5700d2c0766d712f134da86de39b2e/docs/assets/Cosmo.jpg?raw=true" width="144px" height="144px"/>
<h2 id="lovenet-home-operations-repository"><a class="header" href="#lovenet-home-operations-repository">Lovenet Home Operations Repository</a></h2>
<p><em>Managed by Flux, Renovate and GitHub Actions</em> ü§ñ</p>
<p><a href="https://github.com/kashalls/kromgo/"><img src="https://img.shields.io/endpoint?url=https%3A%2F%2Fkromgo.thesteamedcrab.com%2Fquery%3Fformat%3Dendpoint%26metric%3Dkubernetes_version&amp;style=for-the-badge&amp;logo=kubernetes&amp;logoColor=white&amp;color=blue&amp;label=%20" alt="Kubernetes" /></a>¬†¬†
<a href="https://github.com/rwlove/home-ops/actions/workflows/renovate.yaml"><img src="https://img.shields.io/github/actions/workflow/status/rwlove/home-ops/renovate.yaml?branch=main&amp;label=&amp;logo=renovatebot&amp;style=for-the-badge&amp;color=blue" alt="Renovate" /></a>¬†¬†
<a href="https://rwlove.github.io/home-ops/"><img src="https://img.shields.io/badge/documentation-blue?&amp;style=for-the-badge" alt="Documentation" /></a>¬†¬†</p>
<p>Kubernetes Cluster Information</p>
<p><a href="https://github.com/kashalls/kromgo/"><img src="https://img.shields.io/endpoint?url=https%3A%2F%2Fkromgo.thesteamedcrab.com%2Fquery%3Fformat%3Dendpoint%26metric%3Dcluster_age_days&amp;style=flat-square&amp;label=Age" alt="Age-Days" /></a>¬†
<a href="https://github.com/kashalls/kromgo/"><img src="https://img.shields.io/endpoint?url=https%3A%2F%2Fkromgo.thesteamedcrab.com%2Fquery%3Fformat%3Dendpoint%26metric%3Dcluster_node_count&amp;style=flat-square&amp;label=Nodes" alt="Node-Count" /></a>¬†
<a href="https://github.com/kashalls/kromgo/"><img src="https://img.shields.io/endpoint?url=https%3A%2F%2Fkromgo.thesteamedcrab.com%2Fquery%3Fformat%3Dendpoint%26metric%3Dcluster_pod_count&amp;style=flat-square&amp;label=Pods" alt="Pod-Count" /></a>¬†
<a href="https://github.com/kashalls/kromgo/"><img src="https://img.shields.io/endpoint?url=https%3A%2F%2Fkromgo.thesteamedcrab.com%2Fquery%3Fformat%3Dendpoint%26metric%3Dcluster_cpu_usage&amp;style=flat-square&amp;label=CPU" alt="CPU-Usage" /></a>¬†
<a href="https://github.com/kashalls/kromgo/"><img src="https://img.shields.io/endpoint?url=https%3A%2F%2Fkromgo.thesteamedcrab.com%2Fquery%3Fformat%3Dendpoint%26metric%3Dcluster_memory_usage&amp;style=flat-square&amp;label=Memory" alt="Memory-Usage" /></a>¬†
<a href="https://github.com/rwlove/home-ops/actions/workflows/lychee.yaml"><img src="https://github.com/rwlove/home-ops/actions/workflows/lychee.yaml/badge.svg" alt="Check Links" /></a>¬†¬†</p>
<p>Infrastructure Information</p>
<p><a href="https://github.com/kashalls/kromgo"><img src="https://img.shields.io/endpoint?url=https%3A%2F%2Fkromgo.thesteamedcrab.com%2Fcluster_power_usage&amp;style=flat-square&amp;label=Power" alt="Power-Usage" /></a>¬†</p>
</div>
<br><br>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>This is the configuration for my GitOps homelab Kubernetes cluster. This cluster runs home software services for my residence. It is quite complex and there are a lot of interdependencies but the declarative nature of GitOps allows me to manage this mesh of code. The software services fall into a few primary categories:</p>
<ul>
<li>Home Automation (<a href="https://www.home-assistant.io/">Home Assistant</a>, <a href="https://esphome.io/">ESPHome</a>, <a href="https://github.com/node-red/node-red">Node-Red</a>, <a href="https://github.com/emqx/emqx">EMQX</a>, <a href="https://github.com/zwave-js/zwave-js-ui">ZWave JS UI</a>, <a href="https://www.zigbee2mqtt.io/">Zigbee2MQTT</a>)</li>
<li>Home Metering and Monitoring (Weather Station, Power Monitoring, Sensors)</li>
<li>Home Security (<a href="https://frigate.video/">Frigate</a>, <a href="https://github.com/jakowenko/double-take">Double Take</a>)</li>
<li>IOT Devices (<a href="https://kno.wled.ge/">WLED</a>, <a href="https://github.com/PaulWieland/ratgdo">Ratgdo</a>)</li>
</ul>
<h2 id="core-components"><a class="header" href="#core-components">Core Components</a></h2>
<h3 id="infrastructure"><a class="header" href="#infrastructure">Infrastructure</a></h3>
<ul>
<li><a href="https://www.centos.org/centos-stream/">CentOS 9 Stream</a>: Kubernetes Node Operating System.</li>
<li><a href="https://github.com/containers/crun">crun</a>: Container Runtime implemented in C.</li>
<li><a href="https://github.com/NVIDIA/nvidia-container-toolkit">nVIDIA Container Toolkit</a>: Container Runtime for nVIDIA GPUs.</li>
</ul>
<h3 id="networking"><a class="header" href="#networking">Networking</a></h3>
<ul>
<li><a href="https://cilium.io">cilium</a>: Kubernetes Container Network Interface (CNI).</li>
<li><a href="https://cert-manager.io/docs">cert-manager</a>: Creates SSL certificates for services in my Kubernetes cluster.</li>
<li><a href="https://github.com/kubernetes-sigs/external-dns">external-dns</a>: Automatically manages DNS records from my cluster in a cloud DNS provider.</li>
<li><a href="https://github.com/kubernetes/ingress-nginx">ingress-nginx</a>: Ingress controller to expose HTTP traffic to pods over DNS.</li>
<li><a href="https://github.com/cloudflare/cloudflared">Cloudflared</a>: Cloudflare tunnel client.</li>
</ul>
<h3 id="storage"><a class="header" href="#storage">Storage</a></h3>
<ul>
<li><a href="https://github.com/rook/rook">Rook-Ceph</a>: Distributed block storage for peristent storage..</li>
<li><a href="https://min.io/">Minio</a>: S3 Compatible Storage Interface.</li>
<li><a href="https://longhorn.io/">Longhorn</a>: Cloud native distributed block storage for Kubernetes.</li>
<li><a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">NFS</a>: NFS storage.</li>
</ul>
<h3 id="gitops"><a class="header" href="#gitops">GitOps</a></h3>
<ul>
<li><a href="https://github.com/fluxcd/flux2">Flux2</a>: Declarative Cluster GitOps</li>
<li><a href="https://github.com/actions/actions-runner-controller">actions-runner-controller</a>: Self-hosted Github runners.</li>
<li><a href="https://toolkit.fluxcd.io/guides/mozilla-sops/">sops</a>: Managed secrets for Kubernetes which are commited to Git.</li>
<li><a href="https://github.com/renovatebot/renovate">Rennovate</a>: Automated Cluster Management.</li>
</ul>
<hr />
<h2 id="--configuration"><a class="header" href="#--configuration">‚öôÔ∏è¬† Configuration</a></h2>
<ul>
<li><a href="https://github.com/rwlove/home-assistant-config">Home Assistant</a></li>
<li><a href="https://github.com/rwlove/node-red-hass-flows">Node Red</a></li>
<li><a href="https://github.com/rwlove/esphome_config">ESPHome</a></li>
</ul>
<hr />
<h2 id="--hardware"><a class="header" href="#--hardware">‚öôÔ∏è¬† Hardware</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Hostname</th><th>Device</th><th>CPU</th><th>RAM</th><th>OS</th><th>Role</th><th>Storage</th><th>IOT</th><th>Network</th></tr></thead><tbody>
<tr><td>master1</td><td>Intel NUC7PJYH</td><td>4</td><td>8  GB</td><td>CentOS 9</td><td>k8s Master</td><td></td><td></td><td></td></tr>
<tr><td>master2</td><td>VM on beast</td><td>3</td><td>8  GB</td><td>CentOS 9</td><td>k8s Master</td><td></td><td></td><td></td></tr>
<tr><td>master3</td><td>VM on beast</td><td>3</td><td>8  GB</td><td>CentOS 9</td><td>k8s Master</td><td></td><td></td><td></td></tr>
<tr><td>worker1</td><td>ThinkCentre M910x</td><td>8</td><td>32 GB</td><td>CentOS 9</td><td>k8s Worker</td><td>longhorn NVMe</td><td>Z-Stick 7</td><td>iot/sec-vlan</td></tr>
<tr><td>worker2</td><td>ThinkCentre M910x</td><td>8</td><td>32 GB</td><td>CentOS 9</td><td>k8s Worker</td><td>longhorn NVMe</td><td></td><td>iot/sec-vlan</td></tr>
<tr><td>worker3</td><td>ThinkCentre M910x</td><td>8</td><td>32 GB</td><td>CentOS 9</td><td>k8s Worker</td><td>longhorn NVMe, ceph osd</td><td>Sonoff</td><td>iot/sec-vlan</td></tr>
<tr><td>worker4</td><td>ThinkCentre M910x</td><td>8</td><td>32 GB</td><td>CentOS 9</td><td>k8s Worker</td><td>longhorn NVMe</td><td>Coral USB</td><td>iot/sec-vlan</td></tr>
<tr><td>worker5</td><td>VM on beast</td><td>10</td><td>24 GB</td><td>CentOS 9</td><td>k8s Worker</td><td>longhorn NVMe, ceph osd</td><td></td><td>iot/sec-vlan</td></tr>
<tr><td>worker6</td><td>VM on beast</td><td>10</td><td>24 GB</td><td>CentOS 9</td><td>k8s Worker</td><td>longhorn NVMe, ceph osd</td><td>skyconnect</td><td>iot/sec-vlan</td></tr>
<tr><td>worker7</td><td>VM on beast</td><td>10</td><td>24 GB</td><td>CentOS 9</td><td>k8s Worker</td><td>longhorn NVMe, ceph osd</td><td></td><td>iot/sec-vlan</td></tr>
<tr><td>worker8</td><td>VM on beast</td><td>10</td><td>58 GB</td><td>CentOS 9</td><td>k8s Worker</td><td>longhorn NVMe, ceph osd</td><td>nVIDIA P40</td><td>iot/sec-vlan</td></tr>
</tbody></table>
</div>
<h2 id="network"><a class="header" href="#network">Network</a></h2>
<details>
  <summary>Click to see a high level physical network diagram</summary>
  <img src="https://github.com/rwlove/home-ops/blob/main/docs/assets/physical-network-diagram.jpg" align="center" width="600px" alt="dns"/>
</details>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>CIDR</th><th>VLAN</th><th>Notes</th></tr></thead><tbody>
<tr><td>Management VLAN</td><td></td><td></td><td>TBD</td></tr>
<tr><td>Default</td><td><code>192.168.0.0/16</code></td><td>0</td><td></td></tr>
<tr><td>IOT VLAN</td><td><code>10.10.20.1/24</code></td><td>20</td><td></td></tr>
<tr><td>Guest VLAN</td><td><code>10.10.30.1/24</code></td><td>30</td><td></td></tr>
<tr><td>Security VLAN</td><td><code>10.10.40.1/24</code></td><td>40</td><td></td></tr>
<tr><td>Kubernetes Pod Subnet (Cilium)</td><td><code>10.42.0.0/16</code></td><td>N/A</td><td></td></tr>
<tr><td>Kubernetes Services Subnet (Cilium)</td><td><code>10.43.0.0/16</code></td><td>N/A</td><td></td></tr>
<tr><td>Kubernetes LB Range (CiliumLoadBalancerIPPool)</td><td><code>10.45.0.1/24</code></td><td>N/A</td><td></td></tr>
</tbody></table>
</div>
<h2 id="-cloud-dependencies"><a class="header" href="#-cloud-dependencies">‚òÅÔ∏è Cloud Dependencies</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Service</th><th>Use</th><th>Cost</th></tr></thead><tbody>
<tr><td><a href="https://1password.com/">1Password</a></td><td>Secrets with <a href="https://external-secrets.io/">External Secrets</a></td><td>~$65 (1 Year)</td></tr>
<tr><td><a href="https://www.cloudflare.com/">Cloudflare</a></td><td>Domain</td><td>Free</td></tr>
<tr><td><a href="https://github.com/">GitHub</a></td><td>Hosting this repository and continuous integration/deployments</td><td>Free</td></tr>
<tr><td><a href="https://www.mailgun.com/">Mailgun</a></td><td>Email hosting</td><td>Free (Flex Plan)</td></tr>
<tr><td><a href="https://pushover.net/">Pushover</a></td><td>Kubernetes Alerts and application notifications</td><td>$10 (One Time)</td></tr>
<tr><td><a href="https://plus.frigate.video/">Frigate Plus</a></td><td>Model training services for Frigate NVR</td><td>$50 (1 Year)</td></tr>
<tr><td></td><td></td><td>Total: ~$9.60/mo</td></tr>
</tbody></table>
</div>
<hr />
<h3 id="noteworthy-documentation"><a class="header" href="#noteworthy-documentation">Noteworthy Documentation</a></h3>
<p><a href="cluster_rebuild.html">Cluster Rebuild Actions</a>¬†¬†
<a href="https://rwlove.github.io/home-ops/init_teardown.html">Initialization and Teardown</a>¬†¬†
<a href="https://rwlove.github.io/home-ops/github_webhook.html">Github Webhook</a>¬†¬†
<a href="https://rwlove.github.io/home-ops/limits.html">Limits and Requests Philosophy</a>¬†¬†
<a href="https://rwlove.github.io/home-ops/debugging.html">Debugging</a>¬†¬†
<a href="immich_cnpg.html">Immich restore to new CNPG database</a>¬†¬†
<a href="https://rwlove.github.io/home-ops/p40.html">nVIDIA P40 GPU</a>¬†¬†</p>
<h3 id="home-ops-search"><a class="header" href="#home-ops-search">Home-Ops Search</a></h3>
<p><a href="https://github.com/whazor">@whazor</a> created <a href="https://nanne.dev/k8s-at-home-search/">this website</a> as a creative way to search Helm Releases across GitHub. You may use it as a means to get ideas on how to configure an applications' Helm values.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="coral-edge-tpu"><a class="header" href="#coral-edge-tpu">Coral Edge TPU</a></h1>
<h1 id="coral-usb"><a class="header" href="#coral-usb">Coral USB</a></h1>
<h2 id="info"><a class="header" href="#info">Info</a></h2>
<p>I didn't seem to have to do any udev rules or build/load the apex driver when passing this device through to
frigate. I had to do those things for the Mini PCIe Coral, but the way I'm doing it now (look at frigate mount
point), it doesn't seem necessary.</p>
<h2 id="usb-resets"><a class="header" href="#usb-resets">USB Resets</a></h2>
<p>Whenever the coral device was attached to the Frigate container it would trigger the following entry in dmesg
and Node Feature Discovery could no longer identify that the node had the device. This resulted in the frigate
staying in a 'Pending' state until I unplugged and then plugged in the Coral USB again. It was very annoying
that if the frigate container ever terminated, I'd have to unplug and then re-plug the USB.</p>
<p><code>[ +12.269474] usb 2-5: reset SuperSpeed USB device number 22 using xhci_hcd [  +0.012155] usb 2-5: LPM exit latency is zeroed, disabling LPM.</code></p>
<p>This hack resolved the USB reset issue: https://github.com/blakeblackshear/frigate/issues/2607#issuecomment-2092965042</p>
<h1 id="coral-mini-pcie"><a class="header" href="#coral-mini-pcie">Coral Mini PCIe</a></h1>
<h2 id="info-1"><a class="header" href="#info-1">Info</a></h2>
<p>Not currently working. For some reason it doesn't show up in 'lspci' in my Dell R730XD. I wonder if using a more
powerful power supply would make a difference.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nvidia-tesla-p40"><a class="header" href="#nvidia-tesla-p40">nVIDIA Tesla P40</a></h1>
<p>nVIDIA GPU ignored on Host (Dell R730xd, CentOS 9), PCI Passthrough to KVM VM, running CentOS 9 as a K8S node running nVIDIA Container Toolkit pods.</p>
<h2 id="host"><a class="header" href="#host">Host</a></h2>
<h3 id="ignore-pci-device"><a class="header" href="#ignore-pci-device">Ignore PCI device</a></h3>
<ol>
<li>Apend to GRUB_CMDLINE_LINUX in /etc/default/grub</li>
</ol>
<p><code>intel_iommu=on pci-stub.ids=10de:1b38</code></p>
<ol start="2">
<li>grub2-mkconfig -o /boot/grub2/grub.cfg</li>
</ol>
<p>This step doesn't seem to be working. I have to manually add the pci-stub directive to the kernel cmdline when the server boots.</p>
<ol start="3">
<li>reboot</li>
</ol>
<h3 id="pci-passthrough-to-vm-via-virt-manager"><a class="header" href="#pci-passthrough-to-vm-via-virt-manager">PCI Passthrough to VM (via virt-manager)</a></h3>
<ol>
<li>Add Hardware -&gt; PCI Host Device</li>
</ol>
<h2 id="in-the-vm"><a class="header" href="#in-the-vm">In the VM</a></h2>
<h3 id="blacklist-nouveau-in-vm"><a class="header" href="#blacklist-nouveau-in-vm">Blacklist nouveau in VM</a></h3>
<ol>
<li>
<p>echo "blacklist nouveau" &gt; /etc/modprobe.d/blacklist-nouveau.conf</p>
</li>
<li>
<p>Comment out the following block in /etc/X11/xorg.conf.d/10-nvidia.conf</p>
</li>
</ol>
<pre><code>#Section "OutputClass"
#    Identifier "nvidia"
#    MatchDriver "nvidia-drm"
#    Driver "nvidia"
#    Option "AllowEmptyInitialConfiguration"
#    Option "PrimaryGPU" "no"
#    Option "SLI" "Auto"
#    Option "BaseMosaic" "on"
#EndSection
</code></pre>
<ol start="3">
<li>reboot</li>
</ol>
<h3 id="install-nvidia-driver"><a class="header" href="#install-nvidia-driver">Install nVIDIA Driver</a></h3>
<p><code>dnf config-manager --add-repo http://developer.download.nvidia.com/compute/cuda/repos/rhel9/$\(uname -i)/cuda-rhel9.repo</code></p>
<p><code>dnf module install nvidia-driver:565-dkms</code></p>
<h4 id="install-nvidia-container-toolkit"><a class="header" href="#install-nvidia-container-toolkit">Install nVIDIA Container Toolkit</a></h4>
<p><code>curl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | sudo tee /etc/yum.repos.d/nvidia-container-toolkit.repo</code></p>
<p><code>dnf install nvidia-container-toolkit</code></p>
<p><code>nvidia-ctk runtime configure --runtime=crio</code></p>
<h4 id="configure-the-runtime"><a class="header" href="#configure-the-runtime">Configure the runtime</a></h4>
<p><code>nvidia-ctk runtime configure --runtime=crio</code></p>
<h4 id="results"><a class="header" href="#results">Results</a></h4>
<p><a href="https://raw.githubusercontent.com/rwlove/home-ops/refs/heads/main/docs/assets/crio.conf">/etc/crio/crio.conf</a>
<a href="https://raw.githubusercontent.com/rwlove/home-ops/refs/heads/main/docs/assets/config.toml">/etc/nvidia-container-runtime/config.toml</a></p>
<h2 id="kubernetes"><a class="header" href="#kubernetes">Kubernetes</a></h2>
<h3 id="install-nvidia-device-plugin"><a class="header" href="#install-nvidia-device-plugin">Install nVIDIA Device Plugin</a></h3>
<p><a href="https://raw.githubusercontent.com/rwlove/home-ops/main/kubernetes/main/apps/kube-system/nvidia-device-plugin/app/helmrelease.yaml">Helm Chart</a></p>
<h2 id="configuration-with-nfd--localai--ollama--etc"><a class="header" href="#configuration-with-nfd--localai--ollama--etc">Configuration with NFD / LocalAI / Ollama / etc</a></h2>
<h3 id="localai"><a class="header" href="#localai">LocalAI</a></h3>
<ol>
<li>make sure runtime is set correctly</li>
<li>confirm that localai is running on the <code>nvidia-container-runtime</code></li>
</ol>
<h3 id="stable-diffusion"><a class="header" href="#stable-diffusion">stable-diffusion</a></h3>
<h2 id="on-node-install-tcmalloc"><a class="header" href="#on-node-install-tcmalloc">On node install TCMalloc</a></h2>
<p>dnf install -y gperftools gperftools-deve</p>
<h2 id="other"><a class="header" href="#other">Other</a></h2>
<h3 id="nvidia-htop"><a class="header" href="#nvidia-htop">nVidia HTOP</a></h3>
<p>Improved <code>nvidia-smi</code> command.</p>
<p><a href="https://github.com/peci1/nvidia-htop">nVidia HTOP</a></p>
<h3 id="fan-speed"><a class="header" href="#fan-speed">Fan Speed</a></h3>
<p><a href="https://www.reddit.com/r/homelab/comments/1217lkl/issues_with_fan_speed_in_r720_with_nvidia_tesla/">IPMI Fan Script Discussion</a></p>
<p><a href="https://github.com/brezlord/iDRAC7_fan_control">Fan Control Script</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cluster-rebuild-actions"><a class="header" href="#cluster-rebuild-actions">Cluster Rebuild Actions</a></h1>
<h2 id="before-cluster-rebuild"><a class="header" href="#before-cluster-rebuild">Before Cluster Rebuild</a></h2>
<ol>
<li>Restore CNPG from backup</li>
</ol>
<p>uncomment section in cluster.yaml</p>
<h2 id="after-cluster-rebuild"><a class="header" href="#after-cluster-rebuild">After Cluster Rebuild</a></h2>
<ol>
<li>Update KUBECONFIG secret in github/home-ops</li>
</ol>
<p>Settings -&gt; (left side) Secrets and Variables -&gt; (submenu) Actions</p>
<p>Edit KUBECONFIG secret with <code>cat ~/.kube/config | base64</code></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="initialization"><a class="header" href="#initialization">Initialization</a></h2>
<p><code>./init/create-cluster.sh</code> (on master)</p>
<p><code>./init/prepare-cluster.sh</code> (on laptop)</p>
<p><code>./init/initialize-cluster.sh</code> (on laptop)</p>
<p><code>ssh root@master1 rm /etc/kubernetes/manifests/kube-vip.yaml</code> (on laptop)</p>
<h2 id="teardown"><a class="header" href="#teardown">Teardown</a></h2>
<p><code>./init/destroy-cluster.sh</code> (on laptop)</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="importing-an-immich-db-backup-into-a-new-cnpg-database"><a class="header" href="#importing-an-immich-db-backup-into-a-new-cnpg-database">Importing an Immich DB backup into a new CNPG database</a></h1>
<ol>
<li>Create the new Immich database</li>
</ol>
<p><code>kubectl cnpg -n databases psql postgres-16 -- -c 'CREATE DATABASE immich;'</code></p>
<ol start="2">
<li>Ensure that you're woring with the primary CNPG instance</li>
</ol>
<p><code>kubectl cnpg -n databases status postgres-16 | grep "Primary instance:"</code></p>
<ol start="3">
<li>Copy the database backup into the container's persistent storage (where there is likely enough room for it)</li>
</ol>
<p><code>kubectl -n databases cp ./immich-db-backup.sql.gz postgres-16-2:/var/lib/postgresql/data/</code></p>
<ol start="4">
<li>Exec into the postgres container</li>
</ol>
<p><code>kubectl -n databases exec -it postgres-16-2 -- bash</code></p>
<ol start="5">
<li>Run the <a href="https://immich.app/docs/administration/backup-and-restore">Immich restore command</a></li>
</ol>
<p><code>gunzip &lt; "immich-db-backup-1735455600013.sql.gz"| sed "s/SELECT pg_catalog.set_config('search_path', '', false);/SELECT pg_catalog.set_config('search_path', 'public, pg_catalog', true);/g" | kubectl cnpg -n databases psql postgres-14 --</code></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="github-webhook"><a class="header" href="#github-webhook">Github Webhook</a></h2>
<p><code>kubectl -n flux-system get receivers.notification.toolkit.fluxcd.io</code> generates token URL to be put into
github.com -&gt; Settings -&gt; Webhooks -&gt; Payload URL</p>
<ul>
<li>Content Type: application/json</li>
<li>Secret: &lt;token from kubectl -n flux-system describe secrets github-webhook-token&gt;</li>
<li>SSL: Enable SSL verification</li>
<li>Which events would you like to trigger this webhook?: Just the push event.</li>
<li>Active: <checked></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h3 id="resources-limits-and-requests-philosophy"><a class="header" href="#resources-limits-and-requests-philosophy">Resources: Limits and Requests Philosophy</a></h3>
<p>In short, do set CPU requests, but don't set CPU limits and set the Memory limit to be the same as the Memory requests.</p>
<ul>
<li><a href="https://home.robusta.dev/blog/stop-using-cpu-limits">CPU Guidance</a></li>
<li><a href="https://home.robusta.dev/blog/kubernetes-memory-limit">Limits Guidance</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="debugging"><a class="header" href="#debugging">Debugging</a></h2>
<ul>
<li>https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/</li>
<li>https://dnschecker.org</li>
<li>https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/</li>
<li>https://github.com/nicolaka/netshoot</li>
<li>https://www.redhat.com/sysadmin/using-nfsstat-nfsiostat</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>






        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
